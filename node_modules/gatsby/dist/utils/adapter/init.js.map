{"version":3,"file":"init.js","names":["getAdaptersCacheDir","join","process","cwd","createAdaptersCacheDir","ensureDir","emptyDir","packageJsonPath","outputJson","name","description","version","private","author","license","getAdapterInit","latestAdapters","getLatestAdapters","adapterToUse","find","candidate","test","reporter","verbose","undefined","versionForCurrentGatsbyVersion","versions","entry","satisfies","gatsbyVersion","includePrerelease","siteRequire","createRequireFromPath","adapterPackageJson","module","adapterGatsbyPeerDependency","moduleVersion","warn","isAdapterCompatible","required","resolve","preferDefault","e","adaptersRequire","installTimer","activityTimer","start","options","stderr","npmAdditionalCliArgs","execa","end","info"],"sources":["../../../src/utils/adapter/init.ts"],"sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport _ from \"lodash\"\nimport { createRequireFromPath } from \"gatsby-core-utils/create-require-from-path\"\nimport { join } from \"path\"\nimport { emptyDir, ensureDir, outputJson } from \"fs-extra\"\nimport execa, { Options as ExecaOptions } from \"execa\"\nimport { version as gatsbyVersion } from \"gatsby/package.json\"\nimport { satisfies } from \"semver\"\nimport type { AdapterInit } from \"./types\"\nimport { preferDefault } from \"../../bootstrap/prefer-default\"\nimport { getLatestAdapters } from \"../get-latest-gatsby-files\"\n\nconst getAdaptersCacheDir = (): string => join(process.cwd(), `.cache/adapters`)\n\nconst createAdaptersCacheDir = async (): Promise<void> => {\n  await ensureDir(getAdaptersCacheDir())\n  await emptyDir(getAdaptersCacheDir())\n\n  const packageJsonPath = join(getAdaptersCacheDir(), `package.json`)\n\n  await outputJson(packageJsonPath, {\n    name: `gatsby-adapters`,\n    description: `This directory contains adapters that have been automatically installed by Gatsby.`,\n    version: `1.0.0`,\n    private: true,\n    author: `Gatsby`,\n    license: `MIT`,\n  })\n}\n\nexport async function getAdapterInit(): Promise<AdapterInit | undefined> {\n  // 1. Find the correct adapter and its details (e.g. version)\n  const latestAdapters = await getLatestAdapters()\n  const adapterToUse = latestAdapters.find(candidate => candidate.test())\n\n  if (!adapterToUse) {\n    reporter.verbose(\n      `No adapter was found for the current environment. Skipping adapter initialization.`\n    )\n    return undefined\n  }\n\n  const versionForCurrentGatsbyVersion = adapterToUse.versions.find(entry =>\n    satisfies(gatsbyVersion, entry.gatsbyVersion, { includePrerelease: true })\n  )\n\n  if (!versionForCurrentGatsbyVersion) {\n    reporter.verbose(\n      `The ${adapterToUse.name} adapter is not compatible with your current Gatsby version ${gatsbyVersion}.`\n    )\n    return undefined\n  }\n\n  // 2. Check if the user has manually installed the adapter and try to resolve it from there\n  try {\n    const siteRequire = createRequireFromPath(`${process.cwd()}/:internal:`)\n    const adapterPackageJson = siteRequire(\n      `${adapterToUse.module}/package.json`\n    )\n    const adapterGatsbyPeerDependency = _.get(\n      adapterPackageJson,\n      `peerDependencies.gatsby`\n    )\n    const moduleVersion = adapterPackageJson?.version\n\n    // Check if the peerDependency of the adapter is compatible with the current Gatsby version\n    if (\n      adapterGatsbyPeerDependency &&\n      !satisfies(gatsbyVersion, adapterGatsbyPeerDependency, {\n        includePrerelease: true,\n      })\n    ) {\n      reporter.warn(\n        `The ${adapterToUse.name} adapter is not compatible with your current Gatsby version ${gatsbyVersion} - It requires gatsby@${adapterGatsbyPeerDependency}`\n      )\n      return undefined\n    }\n\n    // Cross-check the adapter version with the version manifest and see if the adapter version is correct for the current Gatsby version\n    const isAdapterCompatible = satisfies(\n      moduleVersion,\n      versionForCurrentGatsbyVersion.moduleVersion,\n      {\n        includePrerelease: true,\n      }\n    )\n\n    if (!isAdapterCompatible) {\n      reporter.warn(\n        `${adapterToUse.module}@${moduleVersion} is not compatible with your current Gatsby version ${gatsbyVersion} - Install ${adapterToUse.module}@${versionForCurrentGatsbyVersion.moduleVersion} or later.`\n      )\n\n      return undefined\n    }\n\n    const required = siteRequire.resolve(adapterToUse.module)\n\n    if (required) {\n      reporter.verbose(\n        `Reusing existing adapter ${adapterToUse.module} inside node_modules`\n      )\n\n      // TODO: double preferDefault is most ceirtainly wrong - figure it out\n      return preferDefault(preferDefault(await import(required))) as AdapterInit\n    }\n  } catch (e) {\n    // no-op\n  }\n\n  // 3. Check if a previous run has installed the correct adapter into .cache/adapters already and try to resolve it from there\n  try {\n    const adaptersRequire = createRequireFromPath(\n      `${getAdaptersCacheDir()}/:internal:`\n    )\n    const required = adaptersRequire.resolve(adapterToUse.module)\n\n    if (required) {\n      reporter.verbose(\n        `Reusing existing adapter ${adapterToUse.module} inside .cache/adapters`\n      )\n\n      // TODO: double preferDefault is most ceirtainly wrong - figure it out\n      return preferDefault(preferDefault(await import(required))) as AdapterInit\n    }\n  } catch (e) {\n    // no-op\n  }\n\n  const installTimer = reporter.activityTimer(\n    `Installing ${adapterToUse.name} adapter (${adapterToUse.module}@${versionForCurrentGatsbyVersion.moduleVersion})`\n  )\n  // 4. If both a manually installed version and a cached version are not found, install the adapter into .cache/adapters\n  try {\n    installTimer.start()\n    await createAdaptersCacheDir()\n\n    const options: ExecaOptions = {\n      stderr: `inherit`,\n      cwd: getAdaptersCacheDir(),\n    }\n\n    const npmAdditionalCliArgs = [\n      `--no-progress`,\n      `--no-audit`,\n      `--no-fund`,\n      `--loglevel`,\n      `error`,\n      `--color`,\n      `always`,\n      `--legacy-peer-deps`,\n      `--save-exact`,\n    ]\n\n    await execa(\n      `npm`,\n      [\n        `install`,\n        ...npmAdditionalCliArgs,\n        `${adapterToUse.module}@${versionForCurrentGatsbyVersion.moduleVersion}`,\n      ],\n      options\n    )\n\n    installTimer.end()\n\n    reporter.info(\n      `If you plan on staying on this deployment platform, consider installing ${adapterToUse.module} as a dependency in your project. This will give you faster and more robust installs.`\n    )\n\n    const adaptersRequire = createRequireFromPath(\n      `${getAdaptersCacheDir()}/:internal:`\n    )\n    const required = adaptersRequire.resolve(adapterToUse.module)\n\n    if (required) {\n      reporter.verbose(\n        `Using installed adapter ${adapterToUse.module} inside .cache/adapters`\n      )\n\n      // TODO: double preferDefault is most ceirtainly wrong - figure it out\n      return preferDefault(preferDefault(await import(required))) as AdapterInit\n    }\n  } catch (e) {\n    installTimer.end()\n\n    reporter.warn(\n      `Could not install adapter ${adapterToUse.module}. Please install it yourself by adding it to your package.json's dependencies and try building your project again.`\n    )\n  }\n\n  return undefined\n}\n"],"mappings":";;;;;;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA,MAAMA,mBAAmB,GAAG,MAAc,IAAAC,UAAI,EAACC,OAAO,CAACC,GAAG,EAAE,EAAG,iBAAgB,CAAC;AAEhF,MAAMC,sBAAsB,GAAG,YAA2B;EACxD,MAAM,IAAAC,kBAAS,EAACL,mBAAmB,EAAE,CAAC;EACtC,MAAM,IAAAM,iBAAQ,EAACN,mBAAmB,EAAE,CAAC;EAErC,MAAMO,eAAe,GAAG,IAAAN,UAAI,EAACD,mBAAmB,EAAE,EAAG,cAAa,CAAC;EAEnE,MAAM,IAAAQ,mBAAU,EAACD,eAAe,EAAE;IAChCE,IAAI,EAAG,iBAAgB;IACvBC,WAAW,EAAG,oFAAmF;IACjGC,OAAO,EAAG,OAAM;IAChBC,OAAO,EAAE,IAAI;IACbC,MAAM,EAAG,QAAO;IAChBC,OAAO,EAAG;EACZ,CAAC,CAAC;AACJ,CAAC;AAEM,eAAeC,cAAc,GAAqC;EACvE;EACA,MAAMC,cAAc,GAAG,MAAM,IAAAC,uCAAiB,GAAE;EAChD,MAAMC,YAAY,GAAGF,cAAc,CAACG,IAAI,CAACC,SAAS,IAAIA,SAAS,CAACC,IAAI,EAAE,CAAC;EAEvE,IAAI,CAACH,YAAY,EAAE;IACjBI,iBAAQ,CAACC,OAAO,CACb,oFAAmF,CACrF;IACD,OAAOC,SAAS;EAClB;EAEA,MAAMC,8BAA8B,GAAGP,YAAY,CAACQ,QAAQ,CAACP,IAAI,CAACQ,KAAK,IACrE,IAAAC,iBAAS,EAACC,gBAAa,EAAEF,KAAK,CAACE,aAAa,EAAE;IAAEC,iBAAiB,EAAE;EAAK,CAAC,CAAC,CAC3E;EAED,IAAI,CAACL,8BAA8B,EAAE;IACnCH,iBAAQ,CAACC,OAAO,CACb,OAAML,YAAY,CAACT,IAAK,+DAA8DoB,gBAAc,GAAE,CACxG;IACD,OAAOL,SAAS;EAClB;;EAEA;EACA,IAAI;IACF,MAAMO,WAAW,GAAG,IAAAC,4CAAqB,EAAE,GAAE9B,OAAO,CAACC,GAAG,EAAG,aAAY,CAAC;IACxE,MAAM8B,kBAAkB,GAAGF,WAAW,CACnC,GAAEb,YAAY,CAACgB,MAAO,eAAc,CACtC;IACD,MAAMC,2BAA2B,GAAG,mBAClCF,kBAAkB,EACjB,yBAAwB,CAC1B;IACD,MAAMG,aAAa,GAAGH,kBAAkB,aAAlBA,kBAAkB,uBAAlBA,kBAAkB,CAAEtB,OAAO;;IAEjD;IACA,IACEwB,2BAA2B,IAC3B,CAAC,IAAAP,iBAAS,EAACC,gBAAa,EAAEM,2BAA2B,EAAE;MACrDL,iBAAiB,EAAE;IACrB,CAAC,CAAC,EACF;MACAR,iBAAQ,CAACe,IAAI,CACV,OAAMnB,YAAY,CAACT,IAAK,+DAA8DoB,gBAAc,yBAAwBM,2BAA4B,EAAC,CAC3J;MACD,OAAOX,SAAS;IAClB;;IAEA;IACA,MAAMc,mBAAmB,GAAG,IAAAV,iBAAS,EACnCQ,aAAa,EACbX,8BAA8B,CAACW,aAAa,EAC5C;MACEN,iBAAiB,EAAE;IACrB,CAAC,CACF;IAED,IAAI,CAACQ,mBAAmB,EAAE;MACxBhB,iBAAQ,CAACe,IAAI,CACV,GAAEnB,YAAY,CAACgB,MAAO,IAAGE,aAAc,uDAAsDP,gBAAc,cAAaX,YAAY,CAACgB,MAAO,IAAGT,8BAA8B,CAACW,aAAc,YAAW,CACzM;MAED,OAAOZ,SAAS;IAClB;IAEA,MAAMe,QAAQ,GAAGR,WAAW,CAACS,OAAO,CAACtB,YAAY,CAACgB,MAAM,CAAC;IAEzD,IAAIK,QAAQ,EAAE;MACZjB,iBAAQ,CAACC,OAAO,CACb,4BAA2BL,YAAY,CAACgB,MAAO,sBAAqB,CACtE;;MAED;MACA,OAAO,IAAAO,4BAAa,EAAC,IAAAA,4BAAa,EAAC,MAAM,MAAM,CAACF,QAAQ,CAAC,CAAC,CAAC;IAC7D;EACF,CAAC,CAAC,OAAOG,CAAC,EAAE;IACV;EAAA;;EAGF;EACA,IAAI;IACF,MAAMC,eAAe,GAAG,IAAAX,4CAAqB,EAC1C,GAAEhC,mBAAmB,EAAG,aAAY,CACtC;IACD,MAAMuC,QAAQ,GAAGI,eAAe,CAACH,OAAO,CAACtB,YAAY,CAACgB,MAAM,CAAC;IAE7D,IAAIK,QAAQ,EAAE;MACZjB,iBAAQ,CAACC,OAAO,CACb,4BAA2BL,YAAY,CAACgB,MAAO,yBAAwB,CACzE;;MAED;MACA,OAAO,IAAAO,4BAAa,EAAC,IAAAA,4BAAa,EAAC,MAAM,MAAM,CAACF,QAAQ,CAAC,CAAC,CAAC;IAC7D;EACF,CAAC,CAAC,OAAOG,CAAC,EAAE;IACV;EAAA;EAGF,MAAME,YAAY,GAAGtB,iBAAQ,CAACuB,aAAa,CACxC,cAAa3B,YAAY,CAACT,IAAK,aAAYS,YAAY,CAACgB,MAAO,IAAGT,8BAA8B,CAACW,aAAc,GAAE,CACnH;EACD;EACA,IAAI;IACFQ,YAAY,CAACE,KAAK,EAAE;IACpB,MAAM1C,sBAAsB,EAAE;IAE9B,MAAM2C,OAAqB,GAAG;MAC5BC,MAAM,EAAG,SAAQ;MACjB7C,GAAG,EAAEH,mBAAmB;IAC1B,CAAC;IAED,MAAMiD,oBAAoB,GAAG,CAC1B,eAAc,EACd,YAAW,EACX,WAAU,EACV,YAAW,EACX,OAAM,EACN,SAAQ,EACR,QAAO,EACP,oBAAmB,EACnB,cAAa,CACf;IAED,MAAM,IAAAC,cAAK,EACR,KAAI,EACL,CACG,SAAQ,EACT,GAAGD,oBAAoB,EACtB,GAAE/B,YAAY,CAACgB,MAAO,IAAGT,8BAA8B,CAACW,aAAc,EAAC,CACzE,EACDW,OAAO,CACR;IAEDH,YAAY,CAACO,GAAG,EAAE;IAElB7B,iBAAQ,CAAC8B,IAAI,CACV,2EAA0ElC,YAAY,CAACgB,MAAO,uFAAsF,CACtL;IAED,MAAMS,eAAe,GAAG,IAAAX,4CAAqB,EAC1C,GAAEhC,mBAAmB,EAAG,aAAY,CACtC;IACD,MAAMuC,QAAQ,GAAGI,eAAe,CAACH,OAAO,CAACtB,YAAY,CAACgB,MAAM,CAAC;IAE7D,IAAIK,QAAQ,EAAE;MACZjB,iBAAQ,CAACC,OAAO,CACb,2BAA0BL,YAAY,CAACgB,MAAO,yBAAwB,CACxE;;MAED;MACA,OAAO,IAAAO,4BAAa,EAAC,IAAAA,4BAAa,EAAC,MAAM,MAAM,CAACF,QAAQ,CAAC,CAAC,CAAC;IAC7D;EACF,CAAC,CAAC,OAAOG,CAAC,EAAE;IACVE,YAAY,CAACO,GAAG,EAAE;IAElB7B,iBAAQ,CAACe,IAAI,CACV,6BAA4BnB,YAAY,CAACgB,MAAO,oHAAmH,CACrK;EACH;EAEA,OAAOV,SAAS;AAClB"}