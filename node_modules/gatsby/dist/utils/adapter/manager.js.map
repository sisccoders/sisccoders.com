{"version":3,"file":"manager.js","names":["setAdapter","instance","manager","configFromAdapter","config","store","dispatch","type","payload","incompatibleFeatures","supports","pathPrefix","getState","program","prefixPaths","push","trailingSlash","includes","length","map","option","join","reporter","warn","name","line","pluginsToDisable","reason","initAdapterManager","adapter","adapterFromGatsbyConfig","verbose","adapterInit","getAdapterInit","telemetry","trackFeatureIsUsed","noOpAdapterManager","info","directoriesToCache","restoreCache","cache","result","restore","directories","cachedState","readState","Object","keys","storeCache","adapt","mdbInPublicPath","LmdbOnCdnPath","shouldBundleDatastore","mdbPath","getDefaultDbPath","copy","pathExists","unlink","_routesManifest","undefined","_functionsManifest","adaptContext","routesManifest","getRoutesManifest","functionsManifest","getFunctionsManifest","excludeDatastoreFromEngineFunction","deployURL","Error","webpackAssets","setWebpackAssets","assets","routes","state","createHeaders","createHeadersMatcher","headers","fileAssets","Set","globSync","cwd","posix","process","nodir","dot","filePath","slash","addRoute","route","path","startsWith","applyTrailingSlashOption","score","rankRoute","addStaticRoute","pathToFillInPublicDir","has","delete","page","pages","values","htmlRoutePath","getRoutePathFromPage","pageDataRoutePath","generatePageDataPath","pageMode","getPageMode","htmlFilePath","generateHtmlPath","pageDataFilePath","MUST_REVALIDATE_HEADERS","commonFields","functionId","staticQueryComponent","staticQueryComponents","staticQueryResultPath","getStaticQueryPath","hash","appDataFilePath","panic","id","context","asset","PERMAMENT_CACHING_HEADERS","chunkMapFilePath","webpackStatsFilePath","slice","slices","sliceDataPath","addSliceHtmlRoute","hasChildren","sliceHtml1Path","sliceHtml2Path","html","slicesProps","bySliceId","entries","redirect","redirects","fromPath","toPath","status","statusCode","isPermanent","HTTP_STATUS_CODE","MOVED_PERMANENTLY_301","FOUND_302","ignoreCase","BASE_HEADERS","functionInfo","functions","getRoutePathFromFunction","fileAsset","sort","a","b","order","localeCompare","rest","pathToEntryPoint","relativeCompiledFilePath","relativePathWithoutFileExtension","parse","originalRelativeFilePath","dir","requiredFiles","shouldGenerateEngines","getFilesFrom","file"],"sources":["../../../src/utils/adapter/manager.ts"],"sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport { applyTrailingSlashOption, TrailingSlash } from \"gatsby-page-utils\"\nimport { generateHtmlPath } from \"gatsby-core-utils/page-html\"\nimport { slash } from \"gatsby-core-utils/path\"\nimport { generatePageDataPath } from \"gatsby-core-utils/page-data\"\nimport { posix } from \"path\"\nimport { sync as globSync } from \"glob\"\nimport telemetry from \"gatsby-telemetry\"\nimport { copy, pathExists, unlink } from \"fs-extra\"\nimport type {\n  FunctionsManifest,\n  IAdaptContext,\n  RoutesManifest,\n  Route,\n  IAdapterManager,\n  IFunctionRoute,\n  IAdapter,\n  IAdapterFinalConfig,\n  IAdapterConfig,\n} from \"./types\"\nimport { store, readState } from \"../../redux\"\nimport { getPageMode } from \"../page-mode\"\nimport { getStaticQueryPath } from \"../static-query-utils\"\nimport { getAdapterInit } from \"./init\"\nimport {\n  LmdbOnCdnPath,\n  shouldBundleDatastore,\n  shouldGenerateEngines,\n} from \"../engines-helpers\"\nimport {\n  BASE_HEADERS,\n  MUST_REVALIDATE_HEADERS,\n  PERMAMENT_CACHING_HEADERS,\n} from \"./constants\"\nimport { createHeadersMatcher } from \"./create-headers\"\nimport { HTTP_STATUS_CODE } from \"../../redux/types\"\nimport type { IHeader } from \"../../redux/types\"\nimport { rankRoute } from \"../rank-route\"\nimport {\n  getRoutePathFromFunction,\n  getRoutePathFromPage,\n} from \"./get-route-path\"\nimport { noOpAdapterManager } from \"./no-op-manager\"\nimport { getDefaultDbPath } from \"../../datastore/lmdb/lmdb-datastore\"\n\nasync function setAdapter({\n  instance,\n  manager,\n}: {\n  instance?: IAdapter\n  manager: IAdapterManager\n}): Promise<void> {\n  const configFromAdapter = await manager.config()\n\n  store.dispatch({\n    type: `SET_ADAPTER`,\n    payload: {\n      manager,\n      instance,\n      config: configFromAdapter,\n    },\n  })\n\n  if (instance) {\n    // if adapter reports that it doesn't support certain features, we need to fail the build\n    // to avoid broken deploys\n\n    const incompatibleFeatures: Array<string> = []\n\n    // pathPrefix support\n    if (\n      configFromAdapter?.supports?.pathPrefix === false &&\n      store.getState().program.prefixPaths &&\n      store.getState().config.pathPrefix\n    ) {\n      incompatibleFeatures.push(`pathPrefix is not supported.`)\n    }\n\n    // trailingSlash support\n    if (configFromAdapter?.supports?.trailingSlash) {\n      const { trailingSlash } = store.getState().config\n\n      if (\n        !configFromAdapter.supports.trailingSlash.includes(\n          trailingSlash ?? `always`\n        )\n      ) {\n        incompatibleFeatures.push(\n          `trailingSlash option \"${trailingSlash}\". Supported option${\n            configFromAdapter.supports.trailingSlash.length > 1 ? `s` : ``\n          }: ${configFromAdapter.supports.trailingSlash\n            .map(option => `\"${option}\"`)\n            .join(`, `)}`\n        )\n      }\n    }\n\n    if (incompatibleFeatures.length > 0) {\n      reporter.warn(\n        `Adapter \"${\n          instance.name\n        }\" is not compatible with following settings:\\n${incompatibleFeatures\n          .map(line => ` - ${line}`)\n          .join(`\\n`)}`\n      )\n    }\n\n    if (configFromAdapter.pluginsToDisable.length > 0) {\n      store.dispatch({\n        type: `DISABLE_PLUGINS_BY_NAME`,\n        payload: {\n          pluginsToDisable: configFromAdapter.pluginsToDisable,\n          reason: `Not compatible with the \"${instance.name}\" adapter. Please remove it from your gatsby-config.`,\n        },\n      })\n    }\n  }\n}\n\nexport async function initAdapterManager(): Promise<IAdapterManager> {\n  let adapter: IAdapter\n\n  const config = store.getState().config\n  const { adapter: adapterFromGatsbyConfig, trailingSlash, pathPrefix } = config\n\n  // If the user specified an adapter inside their gatsby-config, use that instead of trying to figure out an adapter for the current environment\n  if (adapterFromGatsbyConfig) {\n    adapter = adapterFromGatsbyConfig\n\n    reporter.verbose(`Using adapter ${adapter.name} from gatsby-config`)\n  } else {\n    const adapterInit = await getAdapterInit()\n\n    // If we don't have adapter, use no-op adapter manager\n    if (!adapterInit) {\n      telemetry.trackFeatureIsUsed(`adapter:no-op`)\n\n      const manager = noOpAdapterManager()\n\n      await setAdapter({ manager })\n\n      return manager\n    }\n\n    adapter = adapterInit()\n  }\n\n  reporter.info(`Using ${adapter.name} adapter`)\n  telemetry.trackFeatureIsUsed(`adapter:${adapter.name}`)\n\n  const directoriesToCache = [`.cache`, `public`]\n  const manager: IAdapterManager = {\n    restoreCache: async (): Promise<void> => {\n      if (!adapter.cache) {\n        return\n      }\n\n      const result = await adapter.cache.restore({\n        directories: directoriesToCache,\n        reporter,\n      })\n      if (result === false) {\n        // if adapter reports `false`, we can skip trying to re-hydrate state\n        return\n      }\n\n      const cachedState = readState()\n\n      // readState() returns empty object if there is no cached state or it's corrupted etc\n      // so we want to avoid dispatching RESTORE_CACHE action in that case\n      if (Object.keys(cachedState).length > 0) {\n        store.dispatch({\n          type: `RESTORE_CACHE`,\n          payload: cachedState,\n        })\n      }\n    },\n    storeCache: async (): Promise<void> => {\n      if (!adapter.cache) {\n        return\n      }\n\n      await adapter.cache.store({ directories: directoriesToCache, reporter })\n    },\n    adapt: async (): Promise<void> => {\n      if (!adapter.adapt) {\n        return\n      }\n\n      // handle lmdb file\n      const mdbInPublicPath = `public/${LmdbOnCdnPath}`\n      if (!shouldBundleDatastore()) {\n        const mdbPath = getDefaultDbPath() + `/data.mdb`\n        copy(mdbPath, mdbInPublicPath)\n      } else {\n        // ensure public dir doesn't have lmdb file\n        if (await pathExists(mdbInPublicPath)) {\n          await unlink(mdbInPublicPath)\n        }\n      }\n\n      let _routesManifest: RoutesManifest | undefined = undefined\n      let _functionsManifest: FunctionsManifest | undefined = undefined\n      const adaptContext: IAdaptContext = {\n        get routesManifest(): RoutesManifest {\n          if (!_routesManifest) {\n            _routesManifest = getRoutesManifest()\n          }\n\n          return _routesManifest\n        },\n        get functionsManifest(): FunctionsManifest {\n          if (!_functionsManifest) {\n            _functionsManifest = getFunctionsManifest()\n          }\n\n          return _functionsManifest\n        },\n        reporter,\n        // Our internal Gatsby config allows this to be undefined but for the adapter we should always pass through the default values and correctly show this in the TypeScript types\n        trailingSlash: trailingSlash as TrailingSlash,\n        pathPrefix: pathPrefix as string,\n      }\n\n      await adapter.adapt(adaptContext)\n    },\n    config: async (): Promise<IAdapterFinalConfig> => {\n      let configFromAdapter: undefined | IAdapterConfig = undefined\n      if (adapter.config) {\n        configFromAdapter = await adapter.config({ reporter })\n\n        if (\n          configFromAdapter?.excludeDatastoreFromEngineFunction &&\n          !configFromAdapter?.deployURL\n        ) {\n          throw new Error(\n            `Can't exclude datastore from engine function without adapter providing deployURL`\n          )\n        }\n      }\n\n      return {\n        excludeDatastoreFromEngineFunction:\n          configFromAdapter?.excludeDatastoreFromEngineFunction ?? false,\n        deployURL: configFromAdapter?.deployURL,\n        supports: configFromAdapter?.supports,\n        pluginsToDisable: configFromAdapter?.pluginsToDisable ?? [],\n      }\n    },\n  }\n\n  await setAdapter({ manager, instance: adapter })\n\n  return manager\n}\n\nlet webpackAssets: Set<string> | undefined\nexport function setWebpackAssets(assets: Set<string>): void {\n  webpackAssets = assets\n}\n\ntype RouteWithScore = { score: number } & Route\n\nfunction getRoutesManifest(): RoutesManifest {\n  const routes: Array<RouteWithScore> = []\n  const state = store.getState()\n  const createHeaders = createHeadersMatcher(state.config.headers)\n\n  const fileAssets = new Set(\n    globSync(`**/**`, {\n      cwd: posix.join(process.cwd(), `public`),\n      nodir: true,\n      dot: true,\n    }).map(filePath => slash(filePath))\n  )\n\n  // TODO: This could be a \"addSortedRoute\" function that would add route to the list in sorted order. TBD if necessary performance-wise\n  function addRoute(route: Route): void {\n    if (!route.path.startsWith(`/`)) {\n      route.path = `/${route.path}`\n    }\n\n    // Apply trailing slash behavior unless it's a redirect. Redirects should always be exact matches\n    if (route.type !== `redirect`) {\n      route.path = applyTrailingSlashOption(\n        route.path,\n        state.config.trailingSlash\n      )\n    }\n\n    if (route.type !== `function`) {\n      route.headers = createHeaders(route.path, route.headers)\n    }\n\n    ;(route as RouteWithScore).score = rankRoute(route.path)\n\n    routes.push(route as RouteWithScore)\n  }\n\n  function addStaticRoute({\n    path,\n    pathToFillInPublicDir,\n    headers,\n  }: {\n    path: string\n    pathToFillInPublicDir: string\n    headers: IHeader[\"headers\"]\n  }): void {\n    addRoute({\n      path,\n      type: `static`,\n      filePath: posix.join(`public`, pathToFillInPublicDir),\n      headers,\n    })\n\n    if (fileAssets.has(pathToFillInPublicDir)) {\n      fileAssets.delete(pathToFillInPublicDir)\n    } else {\n      reporter.verbose(\n        `[Adapters] Tried to remove \"${pathToFillInPublicDir}\" from fileAssets but it wasn't there`\n      )\n    }\n  }\n\n  // routes - pages - static (SSG) or function (DSG/SSR)\n  for (const page of state.pages.values()) {\n    const htmlRoutePath = slash(getRoutePathFromPage(page))\n    const pageDataRoutePath = slash(generatePageDataPath(``, htmlRoutePath))\n\n    const pageMode = getPageMode(page)\n\n    if (pageMode === `SSG`) {\n      const htmlFilePath = slash(generateHtmlPath(``, page.path))\n      const pageDataFilePath = slash(generatePageDataPath(``, page.path))\n\n      addStaticRoute({\n        path: htmlRoutePath,\n        pathToFillInPublicDir: htmlFilePath,\n        headers: MUST_REVALIDATE_HEADERS,\n      })\n      addStaticRoute({\n        path: pageDataRoutePath,\n        pathToFillInPublicDir: pageDataFilePath,\n        headers: MUST_REVALIDATE_HEADERS,\n      })\n    } else {\n      const commonFields: Omit<IFunctionRoute, \"path\"> = {\n        type: `function`,\n        functionId: `ssr-engine`,\n      }\n\n      if (pageMode === `DSG`) {\n        commonFields.cache = true\n      }\n\n      addRoute({\n        path: htmlRoutePath,\n        ...commonFields,\n      })\n\n      addRoute({\n        path: pageDataRoutePath,\n        ...commonFields,\n      })\n    }\n  }\n\n  // static query json assets\n  for (const staticQueryComponent of state.staticQueryComponents.values()) {\n    const staticQueryResultPath = getStaticQueryPath(staticQueryComponent.hash)\n    addStaticRoute({\n      path: staticQueryResultPath,\n      pathToFillInPublicDir: staticQueryResultPath,\n      headers: MUST_REVALIDATE_HEADERS,\n    })\n  }\n\n  // app-data.json\n  {\n    const appDataFilePath = posix.join(`page-data`, `app-data.json`)\n    addStaticRoute({\n      path: appDataFilePath,\n      pathToFillInPublicDir: appDataFilePath,\n      headers: MUST_REVALIDATE_HEADERS,\n    })\n  }\n\n  // webpack assets\n  if (!webpackAssets) {\n    reporter.panic({\n      id: `12200`,\n      context: {},\n    })\n  }\n\n  for (const asset of webpackAssets) {\n    addStaticRoute({\n      path: asset,\n      pathToFillInPublicDir: asset,\n      headers: PERMAMENT_CACHING_HEADERS,\n    })\n  }\n\n  // chunk-map.json\n  {\n    const chunkMapFilePath = posix.join(`chunk-map.json`)\n    addStaticRoute({\n      path: chunkMapFilePath,\n      pathToFillInPublicDir: chunkMapFilePath,\n      headers: MUST_REVALIDATE_HEADERS,\n    })\n  }\n\n  // webpack.stats.json\n  {\n    const webpackStatsFilePath = posix.join(`webpack.stats.json`)\n    addStaticRoute({\n      path: webpackStatsFilePath,\n      pathToFillInPublicDir: webpackStatsFilePath,\n      headers: MUST_REVALIDATE_HEADERS,\n    })\n  }\n\n  for (const slice of state.slices.values()) {\n    const sliceDataPath = posix.join(`slice-data`, `${slice.name}.json`)\n\n    addStaticRoute({\n      path: sliceDataPath,\n      pathToFillInPublicDir: sliceDataPath,\n      headers: MUST_REVALIDATE_HEADERS,\n    })\n  }\n\n  function addSliceHtmlRoute(name: string, hasChildren: boolean): void {\n    const sliceHtml1Path = posix.join(`_gatsby`, `slices`, `${name}-1.html`)\n    addStaticRoute({\n      path: sliceHtml1Path,\n      pathToFillInPublicDir: sliceHtml1Path,\n      headers: MUST_REVALIDATE_HEADERS,\n    })\n    if (hasChildren) {\n      const sliceHtml2Path = posix.join(`_gatsby`, `slices`, `${name}-2.html`)\n      addStaticRoute({\n        path: sliceHtml2Path,\n        pathToFillInPublicDir: sliceHtml2Path,\n        headers: MUST_REVALIDATE_HEADERS,\n      })\n    }\n  }\n\n  addSliceHtmlRoute(`_gatsby-scripts`, false)\n  for (const [\n    name,\n    { hasChildren },\n  ] of state.html.slicesProps.bySliceId.entries()) {\n    addSliceHtmlRoute(name, hasChildren)\n  }\n\n  // redirect routes\n  for (const redirect of state.redirects.values()) {\n    addRoute({\n      path: redirect.fromPath,\n      type: `redirect`,\n      toPath: redirect.toPath,\n      status:\n        redirect.statusCode ??\n        (redirect.isPermanent\n          ? HTTP_STATUS_CODE.MOVED_PERMANENTLY_301\n          : HTTP_STATUS_CODE.FOUND_302),\n      ignoreCase: redirect.ignoreCase,\n      headers: BASE_HEADERS,\n    })\n  }\n\n  // function routes\n  for (const functionInfo of state.functions.values()) {\n    addRoute({\n      path: `/api/${getRoutePathFromFunction(functionInfo)}`,\n      type: `function`,\n      functionId: functionInfo.functionId,\n    })\n  }\n\n  for (const fileAsset of fileAssets) {\n    // try to classify remaining assets\n    let headers: IHeader[\"headers\"] | undefined = undefined\n\n    if (fileAsset.startsWith(`~partytown`)) {\n      // no hashes, must revalidate\n      headers = MUST_REVALIDATE_HEADERS\n    } else if (\n      fileAsset.startsWith(`_gatsby/image`) ||\n      fileAsset.startsWith(`_gatsby/file`)\n    ) {\n      headers = PERMAMENT_CACHING_HEADERS\n    }\n\n    if (!headers) {\n      headers = BASE_HEADERS\n    }\n\n    addStaticRoute({\n      path: fileAsset,\n      pathToFillInPublicDir: fileAsset,\n      headers,\n    })\n  }\n\n  return (\n    routes\n      .sort((a, b) => {\n        // The higher the score, the higher the specificity of our path\n        const order = b.score - a.score\n        if (order !== 0) {\n          return order\n        }\n\n        // if specificity is the same we do lexigraphic comparison of path to ensure\n        // deterministic order regardless of order pages where created\n        return a.path.localeCompare(b.path)\n      })\n      // The score should be internal only, so we remove it from the final manifest\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      .map(({ score, ...rest }): Route => {\n        return { ...rest }\n      })\n  )\n}\n\nfunction getFunctionsManifest(): FunctionsManifest {\n  const functions = [] as FunctionsManifest\n\n  for (const functionInfo of store.getState().functions.values()) {\n    const pathToEntryPoint = posix.join(\n      `.cache`,\n      `functions`,\n      functionInfo.relativeCompiledFilePath\n    )\n    const relativePathWithoutFileExtension = posix.join(\n      posix.parse(functionInfo.originalRelativeFilePath).dir,\n      posix.parse(functionInfo.originalRelativeFilePath).name\n    )\n\n    functions.push({\n      functionId: functionInfo.functionId,\n      name: `/api/${relativePathWithoutFileExtension}`,\n      pathToEntryPoint,\n      requiredFiles: [pathToEntryPoint],\n    })\n  }\n\n  if (shouldGenerateEngines()) {\n    function getFilesFrom(dir: string): Array<string> {\n      return globSync(`**/**`, {\n        cwd: posix.join(process.cwd(), dir),\n        nodir: true,\n        dot: true,\n      }).map(file => posix.join(dir, file))\n    }\n\n    functions.push({\n      functionId: `ssr-engine`,\n      pathToEntryPoint: posix.join(`.cache`, `page-ssr`, `lambda.js`),\n      name: `SSR & DSG`,\n      requiredFiles: [\n        `public/404.html`,\n        `public/500.html`,\n        ...(shouldBundleDatastore()\n          ? getFilesFrom(posix.join(`.cache`, `data`, `datastore`))\n          : []),\n        ...getFilesFrom(posix.join(`.cache`, `page-ssr`)),\n        ...getFilesFrom(posix.join(`.cache`, `query-engine`)),\n      ],\n    })\n  }\n\n  return functions\n}\n\nexport { getRoutesManifest, getFunctionsManifest }\n"],"mappings":"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"}